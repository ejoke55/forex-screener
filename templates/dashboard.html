<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 Forex Screener Dashboard - FTMO 11 Instruments</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .status {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 14px;
        }

        .scanning {
            background: #ffd700;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-refresh {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-refresh:hover {
            background: #5568d3;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .signal-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .signal-card.high-confidence {
            border-left: 5px solid #10b981;
        }

        .signal-card.medium-confidence {
            border-left: 5px solid #f59e0b;
        }

        .signal-card.low-confidence {
            border-left: 5px solid #6b7280;
        }

        .signal-card h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 20px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin: 5px 0;
        }

        .confidence-high {
            background: #d1fae5;
            color: #065f46;
        }

        .confidence-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background: #f3f4f6;
            color: #4b5563;
        }

        .signal-details {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }

        .timeframes {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .tf {
            padding: 8px 5px;
            text-align: center;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .tf.up {
            background: #d1fae5;
            color: #065f46;
        }

        .tf.down {
            background: #fee2e2;
            color: #991b1b;
        }

        .tf.mixed {
            background: #fef3c7;
            color: #92400e;
        }

        table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-collapse: collapse;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .no-data {
            background: white;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            color: #666;
        }

        .pivot-table {
            margin: 15px 0;
        }

        .pivot-table td {
            padding: 8px;
        }

        .resistance {
            background: #fee2e2;
            color: #991b1b;
        }

        .support {
            background: #d1fae5;
            color: #065f46;
        }

        .news-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .news-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .news-meta {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .news-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .news-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š V3 Forex Screener - FTMO 11 Instruments</h1>
            <div class="header-info">
                <div class="status">
                    <div class="status-item" id="last-update">Last Update: Never</div>
                    <div class="status-item" id="scan-status">Status: Idle</div>
                    <div class="status-item">Auto-refresh: 30s</div>
                    <div class="status-item">Scan Interval: 5 min</div>
                </div>
                <button class="btn-refresh" onclick="manualScan()">ðŸ”„ Scan Now</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('high-confidence')">ðŸ”¥ High Confidence</button>
            <button class="tab" onclick="showTab('ma-cross')">ðŸ“ˆ MA Cross</button>
            <button class="tab" onclick="showTab('ma-pullback')">ðŸŽ¯ MA Pullback</button>
            <button class="tab" onclick="showTab('technical')">ðŸ“Š Technical Analysis</button>
            <button class="tab" onclick="showTab('news')">ðŸ“° News Impact</button>
            <button class="tab" onclick="showTab('all-instruments')">ðŸ“‹ All Instruments</button>
        </div>

        <div id="high-confidence" class="content active">
            <div class="signals-grid" id="high-confidence-grid">
                <div class="no-data">Loading data...</div>
            </div>
        </div>

        <div id="ma-cross" class="content">
            <div class="signals-grid" id="ma-cross-grid">
                <div class="no-data">Loading data...</div>
            </div>
        </div>

        <div id="ma-pullback" class="content">
            <div class="signals-grid" id="ma-pullback-grid">
                <div class="no-data">Loading data...</div>
            </div>
        </div>

        <div id="technical" class="content">
            <div id="technical-grid" class="signals-grid">
                <div class="no-data">Loading data...</div>
            </div>
        </div>

        <div id="news" class="content">
            <div id="news-container">
                <div class="no-data">Loading news...</div>
            </div>
        </div>

        <div id="all-instruments" class="content">
            <div id="all-instruments-table"></div>
        </div>
    </div>

    <script>
        let currentTab = 'high-confidence';

        function showTab(tab) {
            // Hide all content
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Show selected
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            currentTab = tab;
        }

        function updateDashboard() {
            fetch('/api/results')
                .then(response => response.json())
                .then(data => {
                    // Update header
                    document.getElementById('last-update').textContent =
                        'Last Update: ' + (data.last_update || 'Never');

                    const statusEl = document.getElementById('scan-status');
                    if (data.scanning) {
                        statusEl.textContent = 'Status: Scanning...';
                        statusEl.classList.add('scanning');
                    } else {
                        statusEl.textContent = 'Status: Idle';
                        statusEl.classList.remove('scanning');
                    }

                    // Update all views
                    updateHighConfidence(data.screener_results);
                    updateMACross(data.screener_results);
                    updateMAPullback(data.screener_results);
                    updateTechnicalAnalysis(data.screener_results);
                    updateAllInstruments(data.screener_results);
                })
                .catch(error => console.error('Error fetching data:', error));

            // Fetch news separately
            fetch('/api/news')
                .then(response => response.json())
                .then(data => {
                    updateNews(data);
                })
                .catch(error => console.error('Error fetching news:', error));
        }

        function updateHighConfidence(results) {
            const grid = document.getElementById('high-confidence-grid');
            const signals = [];

            for (const [instrument, data] of Object.entries(results)) {
                const confidence = data.best_confidence || 0;
                if (confidence >= 70) {
                    signals.push({instrument, data, confidence});
                }
            }

            if (signals.length === 0) {
                grid.innerHTML = '<div class="no-data">No high-confidence signals at the moment</div>';
                return;
            }

            signals.sort((a, b) => b.confidence - a.confidence);

            grid.innerHTML = signals.map(s => createSignalCard(s.instrument, s.data)).join('');
        }

        function updateMACross(results) {
            const grid = document.getElementById('ma-cross-grid');
            const signals = [];

            for (const [instrument, data] of Object.entries(results)) {
                if (data.ma_cross && data.ma_cross.cross_detected) {
                    signals.push({instrument, data});
                }
            }

            if (signals.length === 0) {
                grid.innerHTML = '<div class="no-data">No MA cross signals detected</div>';
                return;
            }

            grid.innerHTML = signals.map(s => createSignalCard(s.instrument, s.data, 'ma_cross')).join('');
        }

        function updateMAPullback(results) {
            const grid = document.getElementById('ma-pullback-grid');
            const signals = [];

            for (const [instrument, data] of Object.entries(results)) {
                if (data.ma_pullback && data.ma_pullback.pullback_detected) {
                    signals.push({instrument, data});
                }
            }

            if (signals.length === 0) {
                grid.innerHTML = '<div class="no-data">No MA pullback opportunities detected</div>';
                return;
            }

            grid.innerHTML = signals.map(s => createSignalCard(s.instrument, s.data, 'ma_pullback')).join('');
        }

        function updateTechnicalAnalysis(results) {
            const grid = document.getElementById('technical-grid');
            let html = '';

            for (const [instrument, data] of Object.entries(results)) {
                html += createTechnicalCard(instrument, data);
            }

            grid.innerHTML = html || '<div class="no-data">No data available</div>';
        }

        function updateNews(newsData) {
            const container = document.getElementById('news-container');
            let html = '';

            for (const [pair, articles] of Object.entries(newsData)) {
                if (articles && articles.length > 0) {
                    html += `<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">`;
                    html += `<h2 style="color: #333; margin-bottom: 15px;">${pair}</h2>`;

                    articles.forEach(article => {
                        html += `<div class="news-item">`;
                        html += `<h4>${article.title}</h4>`;
                        html += `<div class="news-meta">${article.source || 'N/A'} - ${article.published_at || 'N/A'}</div>`;
                        if (article.url) {
                            html += `<a href="${article.url}" target="_blank" class="news-link">Read more â†’</a>`;
                        }
                        html += `</div>`;
                    });

                    html += `</div>`;
                }
            }

            container.innerHTML = html || '<div class="no-data">No news available</div>';
        }

        function updateAllInstruments(results) {
            const container = document.getElementById('all-instruments-table');

            if (Object.keys(results).length === 0) {
                container.innerHTML = '<div class="no-data">No data available</div>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>Instrument</th><th>Signal</th><th>Confidence</th><th>Strategy</th><th>M5</th><th>M15</th><th>H1</th><th>H4</th><th>D1</th>';
            html += '</tr></thead><tbody>';

            // Sort by confidence
            const sortedResults = Object.entries(results).sort((a, b) => {
                return (b[1].best_confidence || 0) - (a[1].best_confidence || 0);
            });

            for (const [instrument, data] of sortedResults) {
                const signal = data.overall_signal || 'NEUTRAL';
                const confidence = data.best_confidence || 0;
                const strategy = data.best_strategy || 'N/A';

                html += `<tr>`;
                html += `<td><strong>${instrument}</strong></td>`;
                html += `<td>${signal}</td>`;
                html += `<td><span class="confidence-badge ${getConfidenceClass(confidence)}">${confidence}%</span></td>`;
                html += `<td>${strategy}</td>`;

                ['M5', 'M15', 'H1', 'H4', 'D'].forEach(tf => {
                    const val = data.sma[tf] || 0;
                    const text = val > 0 ? 'ðŸŸ¢' : val < 0 ? 'ðŸ”´' : 'ðŸŸ¡';
                    html += `<td>${text}</td>`;
                });

                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function createSignalCard(instrument, data, focusStrategy = null) {
            const confidence = data.best_confidence || 0;
            const signal = data.overall_signal || 'NEUTRAL';
            const strategy = focusStrategy || data.best_strategy || 'N/A';
            const strategyData = focusStrategy ? data[focusStrategy] : data.sma;

            const confidenceClass = confidence >= 80 ? 'high-confidence' : confidence >= 60 ? 'medium-confidence' : 'low-confidence';
            const badgeClass = confidence >= 80 ? 'confidence-high' : confidence >= 60 ? 'confidence-medium' : 'confidence-low';

            let html = `<div class="signal-card ${confidenceClass}">`;
            html += `<h3>${instrument}</h3>`;
            html += `<span class="confidence-badge ${badgeClass}">${confidence}% Confidence</span>`;
            html += `<div class="signal-details">`;
            html += `<div><strong>Signal:</strong> ${signal}</div>`;
            html += `<div><strong>Strategy:</strong> ${strategy}</div>`;
            if (data.technical_analysis && data.technical_analysis.current_price) {
                html += `<div><strong>Price:</strong> ${data.technical_analysis.current_price.toFixed(5)}</div>`;
            }
            html += `</div>`;

            // Timeframes
            html += `<div class="timeframes">`;
            ['M5', 'M15', 'H1', 'H4', 'D'].forEach(tf => {
                const val = strategyData[tf] || 0;
                const cls = val > 0 ? 'up' : val < 0 ? 'down' : 'mixed';
                const text = val > 0 ? 'UP' : val < 0 ? 'DN' : 'MIX';
                html += `<div class="tf ${cls}">${tf}<br>${text}</div>`;
            });
            html += `</div>`;

            html += `</div>`;
            return html;
        }

        function createTechnicalCard(instrument, data) {
            const ta = data.technical_analysis;
            if (!ta) return '';

            let html = `<div class="signal-card">`;
            html += `<h3>${instrument}</h3>`;
            if (ta.current_price) {
                html += `<div style="font-size: 20px; font-weight: bold; color: #667eea; margin: 10px 0;">${ta.current_price.toFixed(5)}</div>`;
            }

            // Pivot Points
            if (ta.daily_pivots) {
                html += `<table class="pivot-table">`;
                html += `<tr><th colspan="2">Daily Pivot Points</th></tr>`;
                html += `<tr class="resistance"><td>R3</td><td>${ta.daily_pivots.R3}</td></tr>`;
                html += `<tr class="resistance"><td>R2</td><td>${ta.daily_pivots.R2}</td></tr>`;
                html += `<tr class="resistance"><td>R1</td><td>${ta.daily_pivots.R1}</td></tr>`;
                html += `<tr><td>PP</td><td><strong>${ta.daily_pivots.PP}</strong></td></tr>`;
                html += `<tr class="support"><td>S1</td><td>${ta.daily_pivots.S1}</td></tr>`;
                html += `<tr class="support"><td>S2</td><td>${ta.daily_pivots.S2}</td></tr>`;
                html += `<tr class="support"><td>S3</td><td>${ta.daily_pivots.S3}</td></tr>`;
                html += `</table>`;
            }

            // Patterns
            if (ta.pattern_h4 && ta.pattern_h4 !== 'NONE') {
                html += `<div style="margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 5px;">`;
                html += `<strong>H4 Pattern:</strong> ${ta.pattern_h4}`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 80) return 'confidence-high';
            if (confidence >= 60) return 'confidence-medium';
            return 'confidence-low';
        }

        function manualScan() {
            fetch('/api/scan')
                .then(response => response.json())
                .then(data => {
                    alert(data.status);
                    setTimeout(updateDashboard, 2000);
                });
        }

        // Auto-refresh every 30 seconds
        setInterval(updateDashboard, 30000);

        // Initial load
        updateDashboard();
    </script>
</body>
</html>
